<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar" [class.closed]="!sidebarOpen">
    <div class="side-top">
      <div class="brand">
        <div class="badge">TR</div>
        <div class="txt" *ngIf="sidebarOpen">
          <strong>Tourist Panel</strong>
          <span>Explore & book tours</span>
        </div>
      </div>

      <button class="icon-btn" (click)="toggleSidebar()" title="Toggle sidebar">
        <i class="fa-solid fa-bars"></i>
      </button>
    </div>

    <div class="profile" *ngIf="sidebarOpen">
      <div class="avatar"><i class="fa-solid fa-user"></i></div>
      <div>
        <div class="name">{{ currentUser?.name }}</div>
        <div class="role">{{ currentUser?.role }}</div>
      </div>
    </div>

    <nav class="menu">
      <button (click)="setTab('dashboard')" [class.active]="activeTab==='dashboard'">
        <i class="fa-solid fa-chart-line"></i>
        <span *ngIf="sidebarOpen">Dashboard</span>
      </button>

      <button (click)="setTab('tours')" [class.active]="activeTab==='tours'">
        <i class="fa-solid fa-map-location-dot"></i>
        <span *ngIf="sidebarOpen">Available Tours</span>
      </button>

      <button (click)="setTab('bookings')" [class.active]="activeTab==='bookings'">
        <i class="fa-solid fa-calendar-check"></i>
        <span *ngIf="sidebarOpen">My Bookings</span>
      </button>

      <button (click)="setTab('reviews')" [class.active]="activeTab==='reviews'">
        <i class="fa-solid fa-star"></i>
        <span *ngIf="sidebarOpen">Tour Reviews</span>
      </button>

      <button (click)="setTab('profile')" [class.active]="activeTab==='profile'">
        <i class="fa-solid fa-id-badge"></i>
        <span *ngIf="sidebarOpen">Profile</span>
      </button>

      <button class="danger" (click)="logout()">
        <i class="fa-solid fa-right-from-bracket"></i>
        <span *ngIf="sidebarOpen">Logout</span>
      </button>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <header class="topbar">
      <div class="title">
        <h1>{{ activeTab | titlecase }}</h1>
        <p class="muted">Browse tours, create bookings, and leave reviews.</p>
      </div>

      <div class="top-actions">
        <button class="pill" (click)="loadTours()">
          <i class="fa-solid fa-rotate"></i> Refresh Tours
        </button>

        <button class="pill" *ngIf="activeTab==='bookings'" (click)="loadMyBookings()">
          <i class="fa-solid fa-rotate"></i> Refresh Bookings
        </button>
      </div>
    </header>

    <!-- TOAST -->
    <div class="toast" *ngIf="toastMsg()"
         [class.success]="toastType()==='success'"
         [class.error]="toastType()==='error'">
      <i class="fa-solid fa-circle-info" *ngIf="toastType()==='info'"></i>
      <i class="fa-solid fa-circle-check" *ngIf="toastType()==='success'"></i>
      <i class="fa-solid fa-triangle-exclamation" *ngIf="toastType()==='error'"></i>
      <span>{{ toastMsg() }}</span>
    </div>

    <!-- DASHBOARD -->
    <section *ngIf="activeTab==='dashboard'" class="grid">
      <div class="card stat">
        <div class="stat-icon"><i class="fa-solid fa-map-location-dot"></i></div>
        <div>
          <div class="label">Available Tours</div>
          <div class="value">{{ totalTours() }}</div>
        </div>
      </div>

      <div class="card stat">
        <div class="stat-icon"><i class="fa-solid fa-calendar-check"></i></div>
        <div>
          <div class="label">My Bookings</div>
          <div class="value">{{ totalBookings() }}</div>
        </div>
      </div>

      <div class="card stat">
        <div class="stat-icon"><i class="fa-solid fa-hourglass-half"></i></div>
        <div>
          <div class="label">Pending</div>
          <div class="value">{{ pendingBookings() }}</div>
        </div>
      </div>

      <div class="card wide">
        <h3>Quick Actions</h3>
        <div class="quick">
          <button class="pill primary" (click)="setTab('tours')">
            <i class="fa-solid fa-magnifying-glass"></i> Browse Tours
          </button>
          <button class="pill" (click)="setTab('bookings')">
            <i class="fa-solid fa-calendar-check"></i> My Bookings
          </button>
          <button class="pill" (click)="setTab('reviews')">
            <i class="fa-solid fa-star"></i> Tour Reviews
          </button>
        </div>
      </div>
    </section>

    <!-- TOURS -->
    <section *ngIf="activeTab==='tours'" class="card">
      <div class="section-head">
        <h2>Available Tours</h2>

        <div class="tools">
          <input class="input" placeholder="Search tours..." [(ngModel)]="qTours" />
          <select class="input" [(ngModel)]="tourStatusFilter">
            <option value="ALL">All status</option>
            <option *ngFor="let s of statuses" [value]="s">{{ s }}</option>
          </select>
        </div>
      </div>

      <div class="loading" *ngIf="loadingTours()">Loading tours...</div>

      <div class="grid-tours" *ngIf="!loadingTours()">
        <div class="tour-card" *ngFor="let t of filteredTours()">
          <div class="thumb" [style.backgroundImage]="'url(' + imgUrl(t) + ')'">
             <div class="thumb-overlay"></div>

            <span class="tag float"
                  [class.pending]="t.status===TourStatus.Pending"
                  [class.ok]="t.status===TourStatus.Approved || t.status===TourStatus.Confirmed || t.status===TourStatus.Completed"
                  [class.bad]="t.status===TourStatus.Rejected || t.status===TourStatus.Canceled">
              {{ t.status }}
            </span>
          </div>

          <div class="tour-body">
            <div class="row">
              <h3 class="title">{{ t.title }}</h3>
              <div class="price">{{ t.price }}</div>
            </div>

            <p class="desc">{{ t.description }}</p>

            <div class="row small">
              <span><i class="fa-regular fa-calendar"></i> {{ t.date || '—' }}</span>
              <span><i class="fa-regular fa-user"></i> {{ t.user?.name || '—' }}</span>
            </div>

            <div class="tour-actions">
              <button class="pill" (click)="openTourDetails(t)">
                <i class="fa-solid fa-circle-info"></i> Details
              </button>

              <button class="pill primary" (click)="openBookModal(t)">
                <i class="fa-solid fa-calendar-plus"></i> Book
              </button>

              <button class="pill" (click)="openReviewModal(t)">
                <i class="fa-solid fa-star"></i> Review
              </button>
            </div>
          </div>
        </div>

        <div class="empty" *ngIf="filteredTours().length===0">
          No tours found.
        </div>
      </div>
    </section>

    <!-- BOOKINGS -->
    <section *ngIf="activeTab==='bookings'" class="card">
      <div class="section-head">
        <h2>My Bookings</h2>

        <div class="tools">
          <input class="input" placeholder="Search bookings..." [(ngModel)]="qBookings" />
          <button class="pill" (click)="loadMyBookings()"><i class="fa-solid fa-rotate"></i> Refresh</button>
        </div>
      </div>

      <div class="loading" *ngIf="loadingBookings()">Loading bookings...</div>

      <div class="table-wrap" *ngIf="!loadingBookings()">
        <table>
          <thead>
          <tr>
            <th>ID</th>
            <th>Tour</th>
            <th>Date</th>
            <th>Status</th>
            <th style="width:120px;">Action</th>
          </tr>
          </thead>

          <tbody>
          <tr *ngFor="let b of filteredBookings()">
            <td>#{{ b.booking_id }}</td>
            <td>{{ b.tour?.title }}</td>
            <td>{{ b.date }}</td>
            <td>
              <span class="tag"
                    [class.pending]="b.status===BookingStatus.Pending"
                    [class.ok]="b.status===BookingStatus.Approved || b.status===BookingStatus.Confirmed || b.status===BookingStatus.Completed"
                    [class.bad]="b.status===BookingStatus.Rejected || b.status===BookingStatus.Canceled">
                {{ b.status }}
              </span>
            </td>
            <td class="actions">
              <button class="btn-sm bad" (click)="deleteBooking(b.booking_id)" title="Delete booking">
                <i class="fa-solid fa-trash"></i> Delete
              </button>
            </td>
          </tr>
          </tbody>
        </table>

        <div class="empty" *ngIf="filteredBookings().length===0">
          You have no bookings yet.
        </div>
      </div>
    </section>

    <!-- REVIEWS TAB (tour details + reviews list) -->
    <section *ngIf="activeTab==='reviews'" class="card">
      <div class="section-head">
        <h2>Tour Reviews</h2>
        <p class="muted">Open a tour details to view all reviews and add your own.</p>
      </div>

      <div class="mini-grid">
        <div class="mini-tour" *ngFor="let t of filteredTours()">
          <div class="mini-thumb" [style.backgroundImage]="'url(' + imgUrl(t) + ')'"></div>
          <div class="mini-body">
            <strong>{{ t.title }}</strong>
            <span class="muted">{{ t.user?.name || '—' }}</span>
          </div>
          <button class="pill" (click)="openTourDetails(t)">
            <i class="fa-solid fa-circle-info"></i> View
          </button>
        </div>

        <div class="empty" *ngIf="filteredTours().length===0">
          No tours available.
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section *ngIf="activeTab==='profile'" class="card">
      <div class="section-head">
        <h2>Profile</h2>
      </div>

      <div class="profile-box">
        <div class="p-avatar"><i class="fa-solid fa-user"></i></div>
        <div class="p-info">
          <h3>{{ currentUser?.name }}</h3>
          <p class="muted">@{{ currentUser?.username }}</p>
          <p><b>Email:</b> {{ currentUser?.email }}</p>
          <p><b>Role:</b> {{ currentUser?.role }}</p>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- BOOK MODAL -->
<div class="modal" *ngIf="showBookModal" (click)="closeBookModal()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <button class="x" (click)="closeBookModal()">×</button>

    <h2>Book Tour</h2>
    <p class="muted">{{ selectedTour?.title }}</p>

    <form (ngSubmit)="createBooking()">
      <label>
        Booking date
        <input class="input" type="date" [(ngModel)]="bookingForm.date" name="date" required />
      </label>

      <button class="pill primary full" type="submit">
        <i class="fa-solid fa-calendar-plus"></i> Create Booking
      </button>

      <div class="message success" *ngIf="bookSuccess">{{ bookSuccess }}</div>
      <div class="message error" *ngIf="bookError">{{ bookError }}</div>
    </form>
  </div>
</div>

<!-- REVIEW MODAL -->
<div class="modal" *ngIf="showReviewModal" (click)="closeReviewModal()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <button class="x" (click)="closeReviewModal()">×</button>

    <h2>Leave a Review</h2>
    <p class="muted">{{ selectedTour?.title }}</p>

    <form (ngSubmit)="createReview()">
      <label>
        Rating (1-5)
        <input class="input" type="number" min="1" max="5"
               [(ngModel)]="reviewForm.rating" name="rating" required />
      </label>

      <label>
        Comment
        <textarea class="input area" rows="4"
                  [(ngModel)]="reviewForm.comment" name="comment" required></textarea>
      </label>

      <button class="pill primary full" type="submit">
        <i class="fa-solid fa-star"></i> Submit Review
      </button>

      <div class="message success" *ngIf="reviewSuccess">{{ reviewSuccess }}</div>
      <div class="message error" *ngIf="reviewError">{{ reviewError }}</div>
    </form>
  </div>
</div>

<!-- TOUR DETAILS MODAL -->
<div class="modal" *ngIf="showTourDetailsModal" (click)="closeTourDetails()">
  <div class="modal-box wide" (click)="$event.stopPropagation()">
    <button class="x" (click)="closeTourDetails()">×</button>

    <h2>Tour Details</h2>
    <p class="muted">View details and reviews.</p>

    <div class="details-grid" *ngIf="selectedTour as t">
      <div class="details-cover" [style.backgroundImage]="'url(' + imgUrl(t) + ')'"></div>

      <div class="details-info">
        <div class="d-row">
          <h3 class="d-title">{{ t.title }}</h3>
          <span class="tag"
                [class.pending]="t.status===TourStatus.Pending"
                [class.ok]="t.status===TourStatus.Approved || t.status===TourStatus.Confirmed || t.status===TourStatus.Completed"
                [class.bad]="t.status===TourStatus.Rejected || t.status===TourStatus.Canceled">
            {{ t.status }}
          </span>
        </div>

        <p class="muted">{{ t.description }}</p>

        <div class="d-meta">
          <span><i class="fa-regular fa-calendar"></i> {{ t.date || '—' }}</span>
          <span><i class="fa-solid fa-tag"></i> {{ t.price }}</span>
          <span><i class="fa-regular fa-user"></i> {{ t.user?.name || '—' }}</span>
        </div>

        <div class="d-actions">
          <button class="pill primary" (click)="openBookModal(t)">
            <i class="fa-solid fa-calendar-plus"></i> Book
          </button>

          <button class="pill" (click)="openReviewModal(t)">
            <i class="fa-solid fa-star"></i> Review
          </button>

          <button class="pill" (click)="loadReviewsForTour(t.tour_id)">
            <i class="fa-solid fa-rotate"></i> Refresh Reviews
          </button>
        </div>
      </div>
    </div>

    <hr class="line" />

    <div class="reviews-head">
      <h3>Reviews</h3>
      <span class="muted" *ngIf="selectedTourReviews().length">
        Total: {{ selectedTourReviews().length }}
      </span>
    </div>

    <div class="loading" *ngIf="loadingReviews()">Loading reviews...</div>

    <div class="reviews-list" *ngIf="!loadingReviews()">
      <div class="review-card" *ngFor="let r of selectedTourReviews()">
        <div class="r-top">
          <div>
            <strong>{{ r.user?.name || 'Tourist' }}</strong>
            <span class="stars">
              <i class="fa-solid fa-star" *ngFor="let _ of [].constructor(r.rating)"></i>
            </span>
          </div>
          <span class="muted">{{ r.reviewDate }}</span>
        </div>

        <p class="r-text">{{ r.comment }}</p>
      </div>

      <div class="empty" *ngIf="selectedTourReviews().length===0">
        No reviews for this tour yet.
      </div>
    </div>

  </div>
</div>