<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar" [class.closed]="!sidebarOpen">
    <div class="side-top">
      <div class="brand">
        <div class="badge">GD</div>
        <div class="txt" *ngIf="sidebarOpen">
          <strong>Guide Panel</strong>
          <span>Manage your tours</span>
        </div>
      </div>

      <button class="icon-btn" (click)="toggleSidebar()" title="Toggle sidebar">
        <i class="fa-solid fa-bars"></i>
      </button>
    </div>

    <div class="profile" *ngIf="sidebarOpen">
      <div class="avatar"><i class="fa-solid fa-user"></i></div>
      <div>
        <div class="name">{{ currentUser?.name }}</div>
        <div class="role">{{ currentUser?.role }}</div>
      </div>
    </div>

    <nav class="menu">
      <button (click)="setTab('dashboard')" [class.active]="activeTab==='dashboard'">
        <i class="fa-solid fa-chart-line"></i>
        <span *ngIf="sidebarOpen">Dashboard</span>
      </button>

      <button (click)="setTab('tours')" [class.active]="activeTab==='tours'">
        <i class="fa-solid fa-map-location-dot"></i>
        <span *ngIf="sidebarOpen">My Tours</span>
      </button>

      <button (click)="setTab('bookings')" [class.active]="activeTab==='bookings'">
        <i class="fa-solid fa-calendar-check"></i>
        <span *ngIf="sidebarOpen">Bookings</span>
      </button>

      <button (click)="setTab('reviews')" [class.active]="activeTab==='reviews'">
        <i class="fa-solid fa-star"></i>
        <span *ngIf="sidebarOpen">Reviews</span>
      </button>

      <button (click)="setTab('profile')" [class.active]="activeTab==='profile'">
        <i class="fa-solid fa-id-badge"></i>
        <span *ngIf="sidebarOpen">Profile</span>
      </button>

      <button class="danger" (click)="logout()">
        <i class="fa-solid fa-right-from-bracket"></i>
        <span *ngIf="sidebarOpen">Logout</span>
      </button>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <header class="topbar">
      <div class="title">
        <h1>{{ activeTab | titlecase }}</h1>
        <p class="muted">Create tours, manage statuses, view bookings and reviews.</p>
      </div>

      <div class="top-actions">
        <button class="pill" (click)="loadTours()" title="Refresh tours">
          <i class="fa-solid fa-rotate"></i>
          <span>Refresh</span>
        </button>

        <button class="pill primary" *ngIf="activeTab==='tours'" (click)="openTourModal()" style="background: #0044ff;">
          <i class="fa-solid fa-plus"></i>
          <span>Add Tour</span>
        </button>

        <button class="pill" *ngIf="activeTab==='bookings'" (click)="loadBookings()">
          <i class="fa-solid fa-rotate"></i>
          <span>Refresh Bookings</span>
        </button>
      </div>
    </header>

    <!-- TOAST -->
    <div class="toast" *ngIf="toastMsg()"
         [class.success]="toastType()==='success'"
         [class.error]="toastType()==='error'">
      <i class="fa-solid fa-circle-info" *ngIf="toastType()==='info'"></i>
      <i class="fa-solid fa-circle-check" *ngIf="toastType()==='success'"></i>
      <i class="fa-solid fa-triangle-exclamation" *ngIf="toastType()==='error'"></i>
      <span>{{ toastMsg() }}</span>
    </div>

    <!-- DASHBOARD -->
    <section *ngIf="activeTab==='dashboard'" class="grid">
      <div class="card stat">
        <div class="stat-icon"><i class="fa-solid fa-map-location-dot"></i></div>
        <div>
          <div class="label">My Tours</div>
          <div class="value">{{ totalMyTours() }}</div>
        </div>
      </div>

      <div class="card stat">
        <div class="stat-icon"><i class="fa-solid fa-calendar-check"></i></div>
        <div>
          <div class="label">Bookings</div>
          <div class="value">{{ totalMyBookings() }}</div>
        </div>
      </div>

      <div class="card stat">
        <div class="stat-icon"><i class="fa-solid fa-star"></i></div>
        <div>
          <div class="label">Reviews</div>
          <div class="value">{{ totalMyReviews() }}</div>
        </div>
      </div>

      <div class="card wide">
        <h3>Quick Actions</h3>
        <div class="quick">
          <button class="pill primary" style="background: #28d895;" (click)="setTab('tours'); openTourModal()">
            <i class="fa-solid fa-plus"></i> Add Tour
          </button>
          <button class="pill" (click)="setTab('bookings')" style="background: #28d895;color: #fff;">
            <i class="fa-solid fa-calendar-check"></i> View Bookings
          </button>
          <button class="pill" (click)="setTab('reviews'); loadReviewsForMyTours()" style="background: #28d895;color: #fff;">
            <i class="fa-solid fa-star"></i> View Reviews
          </button>
        </div>
      </div>
    </section>

    <!-- TOURS -->
    <section *ngIf="activeTab==='tours'" class="card">
      <div class="section-head">
        <h2>My Tours</h2>

        <div class="tools">
          <input class="input" placeholder="Search tours..." [(ngModel)]="qTours" style="background: #d0ddd8;" />

          <select class="input" [(ngModel)]="tourStatusFilter" style="background: #d0ddd8;">
            <option value="ALL">All status</option>
            <option *ngFor="let s of statuses" [value]="s">{{ s }}</option>
          </select>

          <button class="pill primary" style="background: #0000ff;" (click)="openTourModal()">
            <i class="fa-solid fa-plus"></i> Add Tour
          </button>
        </div>
      </div>

      <div class="loading" *ngIf="loadingTours()">Loading tours...</div>

      <div class="grid-tours" *ngIf="!loadingTours()">
        <div class="tour-card" *ngFor="let t of myTours()">
          <div class="thumb" [style.backgroundImage]="'url(' + imgUrl(t) + ')'">
            <span class="tag float"
                  [class.pending]="t.status===Status.Pending"
                  [class.ok]="t.status===Status.Approved || t.status===Status.Confirmed || t.status===Status.Completed"
                  [class.bad]="t.status===Status.Rejected || t.status===Status.Canceled">
              {{ t.status }}
            </span>
          </div>

          <div class="tour-body">
            <div class="row">
              <h3 class="title">{{ tourTitle(t) }}</h3>
              <div class="price">{{ tourPrice(t) }}</div>
            </div>

            <p class="desc">{{ tourDesc(t) }}</p>

            <div class="row small">
              <span><i class="fa-regular fa-calendar"></i> {{ t.date || '—' }}</span>
            </div>

            <div class="tour-actions">
              <select class="input" [ngModel]="t.status" (ngModelChange)="updateTourStatus(t.tour_id, $event)">
                <option *ngFor="let s of statuses" [ngValue]="s">{{ s }}</option>
              </select>

              <button class="pill danger" (click)="deleteTour(t.tour_id)">
                <i class="fa-solid fa-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>

        <div class="empty" *ngIf="myTours().length===0">
          No tours yet. Click “Add Tour”.
        </div>
      </div>
    </section>

    <!-- BOOKINGS -->
    <section *ngIf="activeTab==='bookings'" class="card">
      <div class="section-head">
        <h2>Bookings (for your tours)</h2>

        <div class="tools">
          <input class="input" placeholder="Search booking/user/tour..." [(ngModel)]="qBookings" style="background: #d0ddd8;"/>
        </div>
      </div>

      <div class="loading" *ngIf="loadingBookings()">Loading bookings...</div>

      <div class="table-wrap" *ngIf="!loadingBookings()">
        <table>
          <thead>
          <tr>
            <th>ID</th>
            <th>Tour</th>
            <th>Tourist</th>
            <th>Date</th>
            <th>Status</th>
            <th style="width:220px;">Actions</th>
          </tr>
          </thead>

          <tbody>
          <tr *ngFor="let b of myBookings()">
            <td>#{{ b.booking_id }}</td>
            <td>{{ bookingTourTitle(b) }}</td>
            <td>{{ b.user?.name }}</td>
            <td>{{ b.date }}</td>
            <td>
              <span class="tag"
                    [class.pending]="b.status===Status.Pending"
                    [class.ok]="b.status===Status.Approved || b.status===Status.Confirmed || b.status===Status.Completed"
                    [class.bad]="b.status===Status.Rejected || b.status===Status.Canceled">
                {{ b.status }}
              </span>
            </td>
            <td class="actions">
              <button class="btn-sm ok" (click)="approveBooking(b.booking_id)">
                <i class="fa-solid fa-check"></i> Approve
              </button>
              <button class="btn-sm bad" (click)="rejectBooking(b.booking_id)">
                <i class="fa-solid fa-xmark"></i> Reject
              </button>
            </td>
          </tr>
          </tbody>
        </table>

        <div class="empty" *ngIf="myBookings().length===0">
          No bookings found for your tours.
        </div>
      </div>
    </section>

    <!-- REVIEWS -->
    <section *ngIf="activeTab==='reviews'" class="card">
      <div class="section-head">
        <h2>Reviews (your tours)</h2>

        <div class="tools">
          <input class="input" placeholder="Search reviews..." [(ngModel)]="qReviews" style="background: #d0ddd8;"/>
          <button class="pill" (click)="loadReviewsForMyTours()">
            <i class="fa-solid fa-rotate"></i> Refresh
          </button>
        </div>
      </div>

      <div class="loading" *ngIf="loadingReviews()">Loading reviews...</div>

      <div class="reviews-list" *ngIf="!loadingReviews()">
        <div class="review-card" *ngFor="let r of filteredReviews()">
          <div class="r-top">
            <div>
              <strong>{{ r.user?.name || 'Tourist' }}</strong>
              <span class="muted">• {{ reviewTourTitle(r) }}</span>
              <span class="stars">
                <i class="fa-solid fa-star" *ngFor="let _ of [].constructor(r.rating)"></i>
              </span>
            </div>

            <button class="btn-sm bad" (click)="deleteReview(r.review_id)" title="Delete review">
              <i class="fa-solid fa-trash"></i> Delete
            </button>
          </div>

          <p class="r-text">{{ r.comment }}</p>
          <div class="muted r-date">{{ r.reviewDate }}</div>
        </div>

        <div class="empty" *ngIf="filteredReviews().length===0">
          No reviews yet.
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section *ngIf="activeTab==='profile'" class="card">
      <div class="section-head">
        <h2>Profile</h2>
      </div>

      <div class="profile-box">
        <div class="p-avatar"><i class="fa-solid fa-user"></i></div>
        <div class="p-info">
          <h3>{{ currentUser?.name }}</h3>
          <p class="muted">@{{ currentUser?.username }}</p>
          <p><b>Email:</b> {{ currentUser?.email }}</p>
          <p><b>Role:</b> {{ currentUser?.role }}</p>
        </div>
      </div>

      <div class="muted note">
        Guide profile edit inaweza kuongezwa baadaye (update user endpoint ipo tayari).
      </div>
    </section>

  </main>
</div>

<!-- ADD TOUR MODAL -->
<div class="modal" *ngIf="showTourModal" (click)="closeTourModal()">
  <div class="modal-box wide" (click)="$event.stopPropagation()">
    <button class="x" (click)="closeTourModal()">×</button>

    <h2>Add New Tour</h2>
    <p class="muted">Upload image and provide tour details.</p>

    <form (ngSubmit)="createTour()" class="form-grid">
      <label>
        Title
        <input class="input" type="text" [(ngModel)]="tourForm.title" name="title" required />
      </label>

      <label>
        Date
        <input class="input" type="date" [(ngModel)]="tourForm.date" name="date" required />
      </label>

      <label>
        Price
        <input class="input" type="number" min="0" [(ngModel)]="tourForm.price" name="price" required />
      </label>

      <label>
        Image
        <input class="input" type="file" (change)="onTourImagePicked($event)" accept="image/*" required />
      </label>

      <label class="full">
        Description
        <textarea class="input area" rows="4" [(ngModel)]="tourForm.description" name="description" required></textarea>
      </label>

      <button class="pill primary full" type="submit">
        <i class="fa-solid fa-cloud-arrow-up"></i> Create Tour
      </button>

      <div class="message success" *ngIf="tourSuccess">{{ tourSuccess }}</div>
      <div class="message error" *ngIf="tourError">{{ tourError }}</div>
    </form>
  </div>
</div>